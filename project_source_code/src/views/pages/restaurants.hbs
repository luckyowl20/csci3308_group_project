  <!DOCTYPE html>
<html>

<body>
  <main class="container py-4">
    <h2 class="mb-4">Nearby Restaurants</h2>

    {{#if restaurants.length}}
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {{#each restaurants}}
          <div class="col">
            <div class="card h-100 shadow-sm" data-place-id="{{place_id}}">
              {{#if photo}}
                <img src="{{photo}}" alt="{{name}}" class="card-img-top" style="height: 200px; object-fit: cover;" referrerpolicy="no-referrer">
              {{else}}
                <div class="card-img-top bg-secondary text-white d-flex align-items-center justify-content-center" style="height: 200px;">
                  No image
                </div>
              {{/if}}

              <div class="card-body">
                <h5 class="card-title">{{name}}</h5>
                <p class="card-text">{{address}}</p>
                {{#if rating}}<p class="card-text">⭐ {{rating}}</p>{{/if}}

                {{#includes ../likedPlaceIds place_id}}
                  <form action="/explore/restaurants/like" method="POST" class="d-inline like-form">
                    <input type="hidden" name="placeId" value="{{place_id}}">
                    <button type="submit" class="btn btn-success text-white like-btn" disabled>👍 Like</button>
                  </form>
                {{else}}
                  <form action="/explore/restaurants/like" method="POST" class="d-inline like-form">
                    <input type="hidden" name="placeId" value="{{place_id}}">
                    <button type="submit" class="btn btn-outline-success like-btn">👍 Like</button>
                  </form>
                {{/includes}}

                {{#includes ../dislikedPlaceIds place_id}}
                  <form action="/explore/restaurants/dislike" method="POST" class="d-inline dislike-form">
                    <input type="hidden" name="placeId" value="{{place_id}}">
                    <button type="submit" class="btn btn-danger text-white dislike-btn" disabled>👎 Dislike</button>
                  </form>
                {{else}}
                  <form action="/explore/restaurants/dislike" method="POST" class="d-inline dislike-form">
                    <input type="hidden" name="placeId" value="{{place_id}}">
                    <button type="submit" class="btn btn-outline-danger dislike-btn">👎 Dislike</button>
                  </form>
                {{/includes}}
              </div>
            </div>
          </div>
        {{/each}}
      </div>
    {{else}}
      <p>No restaurants found near you.</p>
    {{/if}}
  </main>
  
  <script>
  document.addEventListener("DOMContentLoaded", function () {
    function handleFormSubmit(form, isLike) {
      form.addEventListener("submit", async function (e) {
        e.preventDefault(); // prevent default form submit behavior

        console.log(isLike);
        const card = e.target.closest(".card");
        const thisBtn = form.querySelector("button"); // the one being clicked
        const otherForm = card.querySelector(isLike ? ".dislike-form" : ".like-form");
        const otherBtn = otherForm.querySelector("button"); // the opposite button


        // Prepare form data
        const formData = new URLSearchParams(new FormData(form));


        // Send the form data with fetch
        try {
          const response = await fetch(form.action, {
            method: form.method,
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formData
          });

          if (response.status === 200) {
            console.log('hit');
            if (isLike) {
              // Disable Like button
              thisBtn.disabled = true;
              thisBtn.classList.remove("btn-outline-success");
              thisBtn.classList.add("btn-success", "text-white");

              // Enable Dislike button
              if (otherBtn) {
                otherBtn.disabled = false;
                otherBtn.classList.remove("btn-danger", "text-white");
                otherBtn.classList.add("btn-outline-danger");
              }
            } else {
              // Disable Dislike button
              thisBtn.disabled = true;
              thisBtn.classList.remove("btn-outline-danger");
              thisBtn.classList.add("btn-danger", "text-white");

              // Enable Like button
              if (otherBtn) {
                otherBtn.disabled = false;
                otherBtn.classList.remove("btn-success", "text-white");
                otherBtn.classList.add("btn-outline-success");
              }
            }
          } else {
            console.error("Unexpected response status:", response.status);
          }
        } catch (err) {
          console.error("Error sending form:", err);
        }
      });
    }

    // Attach to all like forms
    document.querySelectorAll(".like-form").forEach(form => {
      handleFormSubmit(form, true);
    });

    // Attach to all dislike forms
    document.querySelectorAll(".dislike-form").forEach(form => {
      handleFormSubmit(form, false);
    });
  });
</script>

</body>
</html>
